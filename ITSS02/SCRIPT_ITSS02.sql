CREATE DATABASE ITS02DATA
GO
USE ITS02DATA
GO
CREATE TABLE DEPARTMENTS
(
	ID INT PRIMARY KEY,
	NAME VARCHAR(100),
)
GO
CREATE TABLE LOCATIONS
(
	ID INT PRIMARY KEY,
	NAME VARCHAR(100),
)
GO
CREATE TABLE PRIORITIES
(
	ID INT PRIMARY KEY,
	NAME int,
)
GO
CREATE TABLE PARTS
(
	ID INT PRIMARY KEY,
	NAME VARCHAR(100),
	EFFECTIVELIFE INT,
)
GO
CREATE TABLE ASSETGROUPS
(
	ID INT PRIMARY KEY,
	NAME VARCHAR(100),
)
GO
CREATE TABLE EMPLOYEES
(
	ID INT PRIMARY KEY,
	FIRSTNAME VARCHAR(100),
	LASTNAME VARCHAR(100),
	PHONE VARCHAR(12),
	ISADMIN BIT,
	USERNAME VARCHAR(50),
	PASSWORD VARCHAR(50)
)
GO
CREATE TABLE DEPARTMENTLOCATIONS
(
	ID INT PRIMARY KEY,
	DEPARTMENTID INT,
	LOCATIONID INT,
	STARTDATE DATE,
	ENDDATE DATE,

	CONSTRAINT FK_DEPLO_DEP FOREIGN KEY (DEPARTMENTID)
		REFERENCES DEPARTMENTS(ID),
	CONSTRAINT FK_DEPLO_LOC FOREIGN KEY (LOCATIONID)
		REFERENCES LOCATIONS(ID)
)
GO
CREATE TABLE ASSETS 
(
	ID INT PRIMARY KEY,
	ASSETSN VARCHAR(100),
	ASSETNAME VARCHAR(100),
	DEPARTMENTLOCAIONID INT,
	EMPLOYEEID INT,
	ASSETGROUPID INT,
	DESCRIPTION VARCHAR(200),
	WARRANTYDATE DATE,
	CONSTRAINT FK_ASS_ASSG FOREIGN KEY (ASSETGROUPID)
		REFERENCES ASSETGROUPS (ID),
	CONSTRAINT FK_ASS_EMP FOREIGN KEY (EMPLOYEEID)
		REFERENCES EMPLOYEES (ID),
		CONSTRAINT FK_ASS_DEPART FOREIGN KEY (DEPARTMENTLOCAIONID)
		REFERENCES DEPARTMENTLOCATIONS (ID)
)
GO
CREATE TABLE EMERGENCYMAINTENANCES
(
	ID INT IDENTITY(1,1) PRIMARY KEY,
	ASSETID INT, 
	PRIORITYID INT,
	DESCRIPTIONEMERGECY VARCHAR(200),
	ORTHERCONSIDERATIONS VARCHAR(200),
	EMREPORTDATE DATE,
	EMSTARTDATE DATE,
	EMENDDATE DATE,
	EMTECHNICIANNOTE VARCHAR(200),

	CONSTRAINT FK_EMR_ASS FOREIGN KEY (ASSETID)
		REFERENCES ASSETS(ID),
	CONSTRAINT FK_EMR_PRI FOREIGN KEY (PRIORITYID)
		REFERENCES PRIORITIES(ID)
)
GO
CREATE TABLE CHANGEDPARTS
(
	ID INT PRIMARY KEY,
	EMERGENCYMAINTENANCESID INT,
	PARTID INT, 
	AMOUNT INT,

	CONSTRAINT FK_CHG_EMER FOREIGN KEY(EMERGENCYMAINTENANCESID)
	REFERENCES EMERGENCYMAINTENANCES (ID),
	CONSTRAINT FK_CHG_PARTS FOREIGN KEY(PARTID)
	REFERENCES PARTS (ID),
)

INSERT INTO DEPARTMENTS VALUES
(1, 'Center Office'),
(2, 'Center Office 2')
GO
INSERT INTO LOCATIONS VALUES
(1, 'Vinh Long'),
(2, 'Can Tho')
go
SET DATEFORMAT DMY
INSERT INTO DEPARTMENTLOCATIONS VALUES
(1, 1,1,'22/8/2022','22/9/2025'),
(2, 2,2,'22/2/2022','22/3/2025')
go
insert into ASSETGROUPS values
(1,'suction'),
(2, 'hilux'),
(3, 'mooring')
go
insert into  EMPLOYEES values 
(1, 'Ngan','Tran Thi','0125969874',1, 'ngan','123'),
(2, 'Duy','Tran Thi','0125969866',0, 'duy','123')
go
set dateformat dmy
insert into ASSETS values 
(1, '02/03/0022','Suction line',1,1,1,'not thing','2/12/2023'),
(2, '02/03/0055','toyota hilux fa',2,2,2,'not thing','2/12/2023'),
(3, '02/03/0021','Mooring System',1,1,3,'not thing','2/12/2023')
go
insert into PRIORITIES values
(1,1),
(2,2)
go
insert into PARTS values 
(1, 'wheel type 1',12),
(2, 'wheel type 2 ',10)
go
set dateformat dmy
insert into EMERGENCYMAINTENANCES values
(1, 1, 'break wheel 1', 'none','23/11/2023','24/11/2023','30/11/2023','none'),
(2,2 , 'break wheel 2', 'none','23/8/2023','24/8/2023','30/8/2023','none')

go 
insert into CHANGEDPARTS values 
(1,1,1,4), 
(2,2,2,4)


-- display asset list for admin 
select ASSETSN, ASSETNAME, 
(select top(1) EMENDDATE  from EMERGENCYMAINTENANCES  where ASSETID = ass.ID order by EMSTARTDATE desc ) as 'Last closed EM',
(select  COUNT(ASSETID) from EMERGENCYMAINTENANCES where ASSETID = ass.ID and EMENDDATE is not null) as 'number of EMs' from ASSETS ass

select ASSETSN, ASSETNAME, MAX(EMENDDATE) as 'Last closed EM' , count(*)  as 'number of EMs'  from ASSETS ass
left join EMERGENCYMAINTENANCES emm on emm.ASSETID = ass.ID
group by  ASSETSN, ASSETNAME
-- request not complete, tìm những merergency có startreportdate gần nhất nhưng ko có enddate




select ASSETSN, ASSETNAME, 
(select top(1) EMENDDATE  from EMERGENCYMAINTENANCES  where ASSETID = ass.ID order by EMREPORTDATE desc ) as 'Last closed EM',
(select  COUNT(ASSETID) from EMERGENCYMAINTENANCES where ASSETID = ass.ID) as 'number of EMs' from ASSETS ass
where ASSETSN = '02/03/0021'


-- display asset list for account party
select ASSETSN, ASSETNAME, 
(select top(1) EMENDDATE  from EMERGENCYMAINTENANCES  where ASSETID = ass.ID order by EMSTARTDATE desc ) as 'Last closed EM',
(select  COUNT(ASSETID) from EMERGENCYMAINTENANCES where ASSETID = ass.ID and EMENDDATE is not null) as 'number of EMs' from ASSETS ass
join EMPLOYEES  emp on emp.ID = ass.EMPLOYEEID
where EMPLOYEEID = 2


select ASSETSN, ASSETNAME, 
(select top(1) EMENDDATE  from EMERGENCYMAINTENANCES  where ASSETID = ass.ID order by EMSTARTDATE desc ) as 'Last closed EM',
(select  COUNT(ASSETID) from EMERGENCYMAINTENANCES where ASSETID = ass.ID and EMENDDATE is not null) as 'number of EMs' from ASSETS ass
join EMPLOYEES  emp on emp.ID = ass.EMPLOYEEID
where EMPLOYEEID = 2

-- display asset in emer request
select ASSETSN, ASSETNAME, dp.NAME
from ASSETS ass
join DEPARTMENTLOCATIONS dpl   on dpl.ID = ass.DEPARTMENTLOCAIONID
join DEPARTMENTS dp on dpl.DEPARTMENTID = dp.ID
where ass.id = 1

